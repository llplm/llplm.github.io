---
import BaseLayout from '../layouts/BaseLayout.astro';
import { readdirSync, existsSync } from 'fs';
import { join } from 'path';

// Read all photos from /public/photos/
const photosDir = join(process.cwd(), 'public', 'photos');
const photos: string[] = [];

if (existsSync(photosDir)) {
  const readPhotosRecursively = (dir: string, basePath: string = '') => {
    const items = readdirSync(dir, { withFileTypes: true });

    for (const item of items) {
      const itemPath = join(dir, item.name);
      const relativePath = basePath ? `${basePath}/${item.name}` : item.name;

      if (item.isDirectory()) {
        readPhotosRecursively(itemPath, relativePath);
      } else if (item.isFile() && /\.(jpg|jpeg|png|gif|webp)$/i.test(item.name)) {
        photos.push(relativePath);
      }
    }
  };

  readPhotosRecursively(photosDir);
}
---

<BaseLayout title="Photography">
  <div class="photos-page">
    <h1>Photography</h1>

    {photos.length > 0 ? (
      <div class="photo-grid">
        {photos.map((photo, index) => (
          <div class="photo-item card" data-index={index}>
            <img
              src={`/photos/${photo}`}
              alt={photo}
              class="photo-image"
              loading="lazy"
            />
          </div>
        ))}
      </div>
    ) : (
      <div class="retro-border empty-state">
        <p>
          <span class="blink">üì∑</span> No photos yet.
        </p>
        <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
          Add photos to <code>/public/photos/</code>
        </p>
      </div>
    )}

    <!-- Lightbox modal -->
    <div id="lightbox" class="lightbox">
      <div class="lightbox-content">
        <button class="lightbox-close retro-button" aria-label="Close">&times;</button>
        <button class="lightbox-prev retro-button" aria-label="Previous">&larr;</button>
        <button class="lightbox-next retro-button" aria-label="Next">&rarr;</button>
        <img id="lightbox-image" src="" alt="" class="lightbox-image" />
      </div>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ photos }}>
  // Lightbox functionality
  const lightbox = document.getElementById('lightbox');
  const lightboxImage = document.getElementById('lightbox-image');
  const photoItems = document.querySelectorAll('.photo-item');
  let currentIndex = 0;

  function openLightbox(index) {
    currentIndex = index;
    lightboxImage.src = `/photos/${photos[currentIndex]}`;
    lightboxImage.alt = photos[currentIndex];
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
  }

  function showNext() {
    currentIndex = (currentIndex + 1) % photos.length;
    lightboxImage.src = `/photos/${photos[currentIndex]}`;
    lightboxImage.alt = photos[currentIndex];
  }

  function showPrev() {
    currentIndex = (currentIndex - 1 + photos.length) % photos.length;
    lightboxImage.src = `/photos/${photos[currentIndex]}`;
    lightboxImage.alt = photos[currentIndex];
  }

  // Event listeners
  photoItems.forEach((item, index) => {
    item.addEventListener('click', () => openLightbox(index));
  });

  document.querySelector('.lightbox-close').addEventListener('click', closeLightbox);
  document.querySelector('.lightbox-prev').addEventListener('click', showPrev);
  document.querySelector('.lightbox-next').addEventListener('click', showNext);

  // Close on background click
  lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox) {
      closeLightbox();
    }
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!lightbox.classList.contains('active')) return;

    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowRight') showNext();
    if (e.key === 'ArrowLeft') showPrev();
  });
</script>

<style>
  .photos-page {
    max-width: 1200px;
    margin: 0 auto;
  }

  .intro {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin-bottom: 3rem;
  }

  .photo-grid {
    column-count: 4;
    column-gap: 1.5rem;
  }

  .photo-item {
    overflow: hidden;
    padding: 0;
    border: 2px solid var(--text-primary);
    cursor: pointer;
    position: relative;
    margin-bottom: 1.5rem;
    break-inside: avoid;
    display: inline-block;
    width: 100%;
  }

  .photo-item::after {
    content: 'üîç';
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--bg-primary);
    padding: 0.25rem 0.5rem;
    border: 1px solid var(--text-primary);
    opacity: 0;
    transition: opacity 0.3s ease;
    font-size: 0.8rem;
  }

  .photo-item:hover::after {
    opacity: 0.9;
  }

  .photo-image {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.3s ease;
  }

  .photo-item:hover .photo-image {
    transform: scale(1.05);
  }

  /* Lightbox */
  .lightbox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .lightbox.active {
    display: flex;
  }

  .lightbox-content {
    position: relative;
    max-width: 90%;
    max-height: 90%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox-image {
    max-width: 100%;
    max-height: 90vh;
    width: auto;
    height: auto;
    border: 3px solid var(--accent-blue);
  }

  .lightbox-close,
  .lightbox-prev,
  .lightbox-next {
    position: fixed;
    background: var(--bg-primary);
    color: var(--accent-blue);
    border: 2px solid var(--accent-blue);
    padding: 0.75rem 1rem;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 1001;
  }

  .lightbox-close {
    top: 1rem;
    right: 1rem;
  }

  .lightbox-prev {
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
  }

  .lightbox-next {
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
  }

  .lightbox-close:hover,
  .lightbox-prev:hover,
  .lightbox-next:hover {
    background: var(--accent-blue);
    color: var(--bg-primary);
  }

  .empty-state {
    text-align: center;
    padding: 3rem 2rem;
    font-size: 1.1rem;
  }

  .empty-state code {
    background: var(--bg-secondary);
    padding: 0.2rem 0.5rem;
    font-size: 0.9em;
  }

  @media (max-width: 1024px) {
    .photo-grid {
      column-count: 3;
    }
  }

  @media (max-width: 768px) {
    .photo-grid {
      column-count: 2;
      column-gap: 1rem;
    }

    .photo-item {
      margin-bottom: 1rem;
    }

    .lightbox-prev,
    .lightbox-next {
      padding: 0.5rem 0.75rem;
      font-size: 1.2rem;
    }

    .lightbox-close {
      padding: 0.5rem 0.75rem;
      font-size: 1.2rem;
    }
  }

  @media (max-width: 480px) {
    .photo-grid {
      column-count: 1;
    }
  }
</style>
